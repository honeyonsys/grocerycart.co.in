<html>
<head>
<meta charset="UTF-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="description" name="grocery cart">
<meta name="google" content="notranslate" />
<meta content="grocery cart is developed by honeyonsys" name="author">

<!-- Disable tap highlight on IE -->
<meta name="msapplication-tap-highlight" content="no">
<link href="./assets/favicon.ico" rel="icon">
   
<title>Checkout | Grocery cart | Groceries in whole sale rates | online groceries | buy groceries items | buy online</title>    
<link href="assets/style.css" rel="stylesheet">
</head>
<body>
    <div class="navigationBar"></div>
    <div class="contentArea">
        
        <h1>Checkout</h1>
        <div class="checkoutForm">
            <h3>Billing Details</h3>
            <form id="checkOutForm">
                <div class="row">
                    <div class="col-25">
                    <label for="fname">First Name</label>
                    </div>
                    <div class="col-75">
                    <input type="text" id="fname" placeholder="First Name">
                    </div>
                </div>
                <div class="row">
                    <div class="col-25">
                    <label for="lname">Last Name</label>
                    </div>
                    <div class="col-75">
                    <input type="text" id="lname" placeholder="Last Name">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-25">
                    <label for="email">E-Mail</label>
                    </div>
                    <div class="col-75">
                    <input type="text" id="email" placeholder="E-Mail">
                    </div>
                </div>
                <div class="row">
                    <div class="col-25">
                    <label for="address">Your Address</label>
                    </div>
                    <div class="col-75">
                    <input type="text" id="address" placeholder="Full Address">
                    </div>
                </div>
                <div class="row">
                    <div class="col-25">
                    <label for="phone">Phone</label>
                    </div>
                    <div class="col-75">
                    <input type="text" id="phone" placeholder="Phone">
                    </div>
                </div>
                <input type="button" value="Proceed to payment" onclick="sendCheckout()"> 
        </form>
        </div>
        <div class="orderSummary">
            
        </div>
        <form id="checkOutFinalForm" action='https://secure.payu.in/_payment' method='post'>
            <input type="hidden" name="key" value="" />
            <input type="hidden" name="txnid" value="" />
            <input type="hidden" name="amount" value="" />
            <input type="hidden" name="productinfo" value="" />
            <input type="hidden" name="firstname" value="" />
            <input type="hidden" name="email" value="" />
            <input type="hidden" name="phone" value="" />
            <input type="hidden" name="surl" value="" />
            <input type="hidden" name="furl" value="" />
            <input type="hidden" name="hash" value="" />
            <input type="submit">
            
        </form>
        <div class="footerArea"></div>
    </div><!--contentArea ends-->
<script src="main.js"></script>
<script>
    const apiUrl = 'https://honeyonsys.pythonanywhere.com/grocerycart';
    loadCartProducts();
    function loadCartProducts() {
        try {
            var cartProducts = localStorage.getItem('Grocery-Cart');
            var cartJSON = JSON.parse(cartProducts);
            var itemListArea = document.querySelector(".orderSummary");
            if(cartJSON.length > 0) {
                let tableHead = `
                        <h3>Your Order</h3>
                        <table>
                            <tr>
                                <th width="85%">Product Details</th>
                                <th width="15%">Total (₹)</th>
                            </tr>
                `;
                var totalAmount = 0;
                var productInfo = '';
                const html = cartJSON.map( item =>{
                    totalAmount = totalAmount + (item['qty'] * item['amount']);
                    productInfo += '['+item['productName']+', ₹'+item['amount']+ ', qty-'+ item['qty']+']';
                    return `
                    <tr>
                        <td>
                            <img src="assets/images/${item['productImage']}" width="80px" />
                            <br>
                            ${item['productName']} x ${item['qty']} 
                            <br>
                            
                        </td>
                        <td>₹${item['amount'] * item['qty']}</td>
                        
                    </tr>
                    
                    
                    `;
                    });

                let totalAmountRow = `
                    <tr>
                        <td><b>Total:</b></td>
                        <td><b>₹ ${totalAmount}</b></td>
                    </tr>
                `;
                itemListArea.innerHTML = tableHead + html.join('') + totalAmountRow + `</table>`;
                document.querySelector('[name=amount]').value = totalAmount;
                document.querySelector('[name=productinfo]').value = productInfo;
            } else {
                itemListArea.innerHTML = `
                <table>
                <tr><td>There are no items in your cart. Please add some items from <a href="index.html">products page</a></td></tr>
                </table>
                `;
            }
        }
        catch(err) {
            console.log("Error: " + err.message);
        }
    }

    function sendCheckout() {
        let key = document.querySelector('[name=key]');
        let txnid = document.querySelector('[name=txnid]');
        let hash = document.querySelector('[name=hash]');
        let firstName = document.querySelector('[name=firstname]');
        let lastName = document.querySelector('[name=lastname]');
        let email = document.querySelector('[name=email]');
        let address = document.querySelector('[name=address1]');
        let phone = document.querySelector('[name=phone]')
        let productInfo = document.querySelector('[name=productinfo]');
        let amount = document.querySelector('[name=amount]');
        let surl = document.querySelector('[name=surl]');
        let furl = document.querySelector('[name=furl]');
        
        if(txnid.value == "" && hash.value == "") {
            var http = new XMLHttpRequest();
            var url = apiUrl+'/checkout';
            var params = 'key='+key.value+'&txnid=&amount='+amount.value+'&productinfo='+productInfo.value+'&firstname='+document.querySelector('#fname').value+'&email='+document.querySelector('#email').value+'&phone='+document.querySelector('#phone').value+'&surl='+surl.value+'&furl='+furl.value;
            http.open('POST', url, true);

            //Send the proper header information along with the request
            http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

            http.onreadystatechange = function() {//Call a function when the state changes.
                if(http.readyState == 4 && http.status == 200) {
                    var res = JSON.parse(http.responseText);
                    if(res[0].status == 1) {
                        key.value = res[0].key;
                        txnid.value = res[0].txnid;
                        hash.value = res[0].hashh;
                        firstName.value = res[0].posted.firstname;
                        //lastName.value = res[0].posted.lastname;
                        surl.value = apiUrl+'/successpayment';
                        furl.value = apiUrl+'/failedpayment'
                        email.value = res[0].posted.email;
                        phone.value = res[0].posted.phone;
                        document.querySelector('#checkOutFinalForm').submit();
                    }
                }
            }
            http.send(params);
            
        }
        

    }
    

</script>
</body>
</html>




    
    